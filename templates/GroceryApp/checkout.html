{% extends 'partials/base.html' %}
{% load static %}

{% block content %}

    <!-- Breadcrumb Section Begin -->
    <section class="breadcrumb-section set-bg" data-setbg="static/img/breadcrumb.jpg">
        <div class="container">
            <div class="row">
                <div class="col-lg-12 text-center">
                    <div class="breadcrumb__text">
                        <h2>Checkout</h2>
                        <div class="breadcrumb__option">
                            <a href="{% url 'GroceryApp:Home' %}">Home</a>
                            <span>Checkout</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    <!-- Breadcrumb Section End -->

    <!-- Checkout Section Begin -->z
    <form method="POST">
    {% csrf_token %}
    <section class="checkout spad">
        <div class="container">
            <!-- <div class="row">
                <div class="col-lg-12">
                    <h6><span class="icon_tag_alt"></span> Have a coupon? <a href="#">Click here</a> to enter your code
                    </h6>
                </div>
            </div> -->
            <div class="checkout__form">
                <h4>Billing Details</h4>
                <form action="#">
                    <div class="row">
                        <div class="col-lg-8 col-md-6">
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="checkout__input">
                                        <p>Fist Name<span>*</span></p>
                                        <input type="text" name="first_name" value="{{ user.first_name }}" required>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="checkout__input">
                                        <p>Last Name<span>*</span></p>
                                        <input type="text" name="last_name" value="{{ user.last_name }}" required>
                                    </div>
                                </div>
                            </div>
                            <!-- <div class="checkout__input">
                                <p>Country<span>*</span></p>
                                <input type="text">
                            </div> -->
                            <div class="checkout__input">
                                <p>Address<span>*</span></p>
                                <input type="text" placeholder="Street Address" class="checkout__input__add" name="address" required>
                                <input type="text" placeholder="Apartment, suite, unite ect (optinal)" name="apartment" >
                            </div>
                            <div class="checkout__input">
                                <p>Governorate<span>*</span></p>
                                <input type="text" name="governorate" required>
                            </div>
                            <div class="checkout__input">
                                <p>City<span>*</span></p>
                                <input type="text" name="city" required>
                            </div>
                            <div class="checkout__input">
                                <p>Postcode / ZIP<span>*</span></p>
                                <input type="text" name="zip" required>
                            </div>
                            <div class="row">
                                <div class="col-lg-6">
                                    <div class="checkout__input">
                                        <p>Phone<span>*</span></p>
                                        <input type="text" name="phone" required>
                                    </div>
                                </div>
                                <div class="col-lg-6">
                                    <div class="checkout__input">
                                        <p>Email<span>*</span></p>
                                        <input type="text" name="email" value="{{ user.email }}" required>
                                    </div>
                                </div>
                            </div>
                            <!-- <div class="checkout__input__checkbox">
                                <label for="acc">
                                    Create an account?
                                    <input type="checkbox" id="acc">
                                    <span class="checkmark"></span>
                                </label>
                            </div>
                            <p>Create an account by entering the information below. If you are a returning customer
                                please login at the top of the page</p>
                            <div class="checkout__input">
                                <p>Account Password<span>*</span></p>
                                <input type="text">
                            </div> -->
                            <!-- <div class="checkout__input__checkbox">
                                <label for="diff-acc">
                                    Ship to a different address?
                                    <input type="checkbox" id="diff-acc">
                                    <span class="checkmark"></span>
                                </label>
                            </div> -->
                            <div class="checkout__input">
                                <p>Order notes</p>
                                <input type="text"
                                    placeholder="Notes about your order, e.g. special notes for delivery.">
                            </div>
                        </div>
                        <div class="col-lg-4 col-md-6">
                            <div class="checkout__order">
                                <h4>Your Order</h4>
                                <div class="checkout__order__products">Products <span>Total</span></div>
                                <ul>
                                    {% for item in items%}
                                        <li>{{item.title}}<span>{{item.total}}</span></li>
                                    {% endfor %}
                                </ul>
                                <div class="checkout__order__subtotal">Subtotal <span>EGP {{sub_total_price}}</span></div>
                                <div class="checkout__order__total">Total <span>EGP {{total_price}}</span></div>
                                <!-- <div class="checkout__input__checkbox">
                                    <label for="acc-or">
                                        Create an account?
                                        <input type="checkbox" id="acc-or">
                                        <span class="checkmark"></span>
                                    </label>
                                </div> -->
                                <!-- <p>Lorem ipsum dolor sit amet, consectetur adip elit, sed do eiusmod tempor incididunt
                                    ut labore et dolore magna aliqua.</p> -->
                                    <div class="checkout__input__radio">
                                        <label for="payment">
                                            <span class="radiomark"></span>
                                            <input type="radio" id="payment" name="payment_method" value="cash" required>
                                            Cash on Delivery
                                        </label>
                                        <br>
                                        <label for="paypal">
                                            <span class="radiomark"></span>
                                            <input type="radio" id="paypal" name="payment_method" value="paypal" required>
                                            Pay with Paypal
                                        </label>
                                        <br>
                                        <label for="card">
                                            <span class="radiomark"></span>
                                            <input type="radio" id="card" name="payment_method" value="card" required>
                                            Pay with Card (Visa/Mastercard)
                                        </label>
                                    </div> 
                                    <input type="hidden" name="order_id" value="{{ items.0.ct_ord_id }}">
                                    <div id="cardFields" style="display: none;">
                                        <div class="checkout__input">
                                            <p>Card Number<span>*</span></p>
                                            <input type="text" id="cardNumberInput" name="card_number" placeholder="Card Number">
                                        </div>
                                        <div class="checkout__input">
                                            <p>Expiration Date<span>*</span></p>
                                            <input type="text" id="expiryDateInput" name="expiration_date" placeholder="MM/YY">
                                        </div>
                                        <div class="checkout__input">
                                            <p>CVC<span>*</span></p>
                                            <input type="text" id="cvcInput" name="cvc" placeholder="CVC">
                                        </div>
                                    </div>
                                    <button id="placeOrderBtn" type="submit" class="site-btn">PLACE ORDER</button>
                                    
                                    <script>
                                        const cardRadio = document.getElementById('card');
                                        cardRadio.addEventListener('change', function() {
                                            const cardFields = document.getElementById('cardFields');
                                            if (this.checked) {
                                                cardFields.style.display = 'block';
                                            } else {
                                                cardFields.style.display = 'none';
                                            }
                                        });
                                        const cashRadio = document.getElementById('payment');
                                        const paypalRadio = document.getElementById('paypal');
                                        const cardFields = document.getElementById('cardFields');

                                        function toggleCardFields() {
                                            if (cardRadio.checked) {
                                                cardFields.style.display = 'block';
                                            } else {
                                                cardFields.style.display = 'none';
                                            }
                                        }

                                        cardRadio.addEventListener('change', toggleCardFields);
                                        cashRadio.addEventListener('change', toggleCardFields);
                                        paypalRadio.addEventListener('change', toggleCardFields);
                                        function creditCardValidation(card_number) {
                                            var regEx = /^5[1-5][0-9]{14}$|^2(?:2(?:2[1-9]|[3-9][0-9])|[3-6][0-9][0-9]|7(?:[01][0-9]|20))[0-9]{12}$/;
                                            if(card_number.match(regEx)) {
                                                return true;
                                            } else {
                                                return false;
                                            }
                                        }
                                        function expiryDateValidation(expiry_date) {
                                            var regEx = /^(0[1-9]|1[0-2])\/([0-9]{2})$/;
                                            if(expiry_date.match(regEx)) {
                                                return true;
                                            } else {
                                                return false;
                                            }
                                        }

                                        function cvcValidation(cvc) {
                                            var regEx = /^[0-9]{3,4}$/;
                                            if(cvc.match(regEx)) {
                                                return true;
                                            } else {
                                                return false;
                                            }
                                        }
                                        document.getElementById('placeOrderBtn').addEventListener('click', function(event) {
                                        const cardNumberInput = document.getElementById('cardNumberInput');
                                        const expiryDateInput = document.getElementById('expiryDateInput');
                                        expiryDateInput.addEventListener('input', function(e) {
                                        var value = e.target.value;
                                        if (value.length === 2 && !value.includes('/')) {
                                            e.target.value = value + '/';
                                        }
                                        });
                                        const cvcInput = document.getElementById('cvcInput');
                                        if (document.getElementById('card').checked) {
                                            if (cardRadio.checked && !creditCardValidation(cardNumberInput.value)) {
                                                event.preventDefault();
                                                alert('Invalid card number');
                                            } else if (cardRadio.checked && !expiryDateValidation(expiryDateInput.value)) {
                                                event.preventDefault();
                                                alert('Invalid expiry date');
                                            } else if (cardRadio.checked && !cvcValidation(cvcInput.value)) {
                                                event.preventDefault();
                                                alert('Invalid CVC');
                                            }
                                        }
                                    });
                                    </script>                                      
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </section>
</form>
    <!-- Checkout Section End -->

{% endblock content %}